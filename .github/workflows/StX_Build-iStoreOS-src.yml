name: ğŸ’¿ StX_Build-A311D-OES-iStoreOS
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "1ã€è®¾å¤‡å‹å·"
        required: true
        default: "a311d-oes"
        type: choice
        options:
          - a311d-oes
          - s905x3
          - s922x
      openwrt_kernel:
        description: "2ã€å†…æ ¸ç‰ˆæœ¬ (è‹¥å¡« auto åˆ™è‡ªåŠ¨è·å–æœ€æ–° 5.15)"
        required: true
        default: "5.15.167"
      auto_kernel:
        description: "è‡ªåŠ¨åŒ¹é…æœ€æ–°å†…æ ¸"
        required: false
        default: true
        type: boolean

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” æŸ¥æ‰¾rootfsè·¯å¾„
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶ (è‡ªåŠ¨çº é”™æ¨¡å¼)
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: true
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: ğŸ“œ å¼ºåˆ¶æ•´ç†å¹¶é‡å‘½å
        if: always() # å³ä½¿å‰é¢å¤±è´¥ä¹Ÿè¿è¡Œï¼Œæ–¹ä¾¿æŸ¥çœ‹é”™è¯¯
        run: |
          mkdir -p final_out
          echo "ğŸ” æ­£åœ¨å…¨ç³»ç»Ÿæœç´¢æ‰“åŒ…å¥½çš„å›ºä»¶..."
          # æŸ¥æ‰¾ç”Ÿæˆçš„ img.gzï¼Œæ’é™¤æ‰ rootfs
          FOUND=$(find . -name "*.img.gz" ! -name "*rootfs*" -size +50M)
          
          if [ -z "$FOUND" ]; then
            echo "âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ°å›ºä»¶ã€‚è¯·å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹ 'ğŸ§± æ‰“åŒ…å›ºä»¶' æ­¥éª¤ä¸­çš„ curl é”™è¯¯ã€‚"
            # åˆ—å‡ºå½“å‰ç›®å½•ç»“æ„ï¼Œæ–¹ä¾¿è°ƒè¯•
            ls -R
            exit 1
          fi

          for FILE in $FOUND; do
            FILENAME=$(basename "$FILE")
            NEW_NAME="istoreos_A311D_$(date +%Y%m%d).img.gz"
            cp "$FILE" "final_out/$NEW_NAME"
            echo "âœ… æˆåŠŸè·å–å›ºä»¶: $NEW_NAME"
          done

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-${{ env.VERSION }}-${{ github.run_id }}
          name: A311D-OES ç¨³å®šç‰ˆ (å†…æ ¸ ${{ inputs.openwrt_kernel }})
          body: |
            ğŸ› ï¸ ä¸“ä¸º A311D-OES é€‚é…
            ğŸ§  å†…æ ¸ç‰ˆæœ¬: ${{ inputs.openwrt_kernel }}
            ğŸ‘¤ è´¦å·: root | å¯†ç : æ— 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
