name: ğŸ’¿ StX_Build-A311D-OES-FinalFix
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” åŠ¨æ€è·å–å†…æ ¸å¹¶æ³¨å…¥
        id: get_kernel
        run: |
          echo "ğŸŒ æ­£åœ¨ä» ophub ä»“åº“æ£€ç´¢ 5.15 ç¨³å®šç‰ˆå†…æ ¸..."
          # è·å–çœŸå®æ–‡ä»¶å
          KERNEL_FILE=$(curl -s https://api.github.com/repos/ophub/kernel/releases/tags/kernel_stable | grep "name" | grep "5.15" | grep ".tar.gz" | head -n 1 | cut -d '"' -f 4)
          
          if [ -z "$KERNEL_FILE" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° 5.15 å†…æ ¸æ–‡ä»¶"
            exit 1
          fi
          
          # æå–çº¯ç‰ˆæœ¬å· (ä¾‹å¦‚ 5.15.193)
          K_VER=$(echo $KERNEL_FILE | cut -d '.' -f 1,2,3 | cut -d '-' -f 1)
          
          echo "âœ… æ‰¾åˆ°æœ€æ–°å†…æ ¸æ–‡ä»¶: $KERNEL_FILE"
          echo "k_ver=$K_VER" >> $GITHUB_OUTPUT
          
          # ä¸‹è½½å†…æ ¸
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/$KERNEL_FILE \
            https://github.com/ophub/kernel/releases/download/kernel_stable/$KERNEL_FILE
          
          # --- ä¿®æ­£ç‚¹ï¼šåªæœ‰å½“æ–‡ä»¶åä¸ä¸€è‡´æ—¶æ‰åˆ›å»ºè½¯é“¾æ¥ï¼Œä¸”ä½¿ç”¨ -sf å¼ºåˆ¶è¦†ç›– ---
          if [ "$KERNEL_FILE" != "$K_VER.tar.gz" ]; then
            ln -sf $KERNEL_FILE amlogic-s9xxx-openwrt/amlogic-kernel/$K_VER.tar.gz
          fi
          echo "âœ… å†…æ ¸æ³¨å…¥å®Œæˆ"

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          openwrt_kernel: ${{ steps.get_kernel.outputs.k_ver }}
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æœå¯»å¹¶æ•´ç†å›ºä»¶
        if: always()
        run: |
          mkdir -p final_out
          # æŸ¥æ‰¾æ‰€æœ‰å¤§äº 50M çš„å›ºä»¶åŒ…
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/ \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ æ‰“åŒ…æœªæˆåŠŸï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹ 'ğŸ§± æ‰“åŒ…å›ºä»¶' æ­¥éª¤æ—¥å¿—ã€‚"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-iStoreOS-${{ github.run_id }}
          name: A311D-OES ç¨³å®šç‰ˆ (å†…æ ¸ ${{ steps.get_kernel.outputs.k_ver }})
          body: |
            ğŸ› ï¸ A311D-OES ä¸“ç”¨å›ºä»¶
            ğŸ§  å†…æ ¸ç‰ˆæœ¬: ${{ steps.get_kernel.outputs.k_ver }}
            ğŸ‘¤ è´¦å·: root | å¯†ç : æ— 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
