name: ğŸ’¿ StX_Build-A311D-OES-Fixed
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” é¢„è½½å†…æ ¸ (é˜²æ­¢æ’ä»¶ä¸‹è½½ 404)
        run: |
          # åˆ›å»ºæ’ä»¶é»˜è®¤çš„å†…æ ¸å­˜æ”¾ç›®å½•
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          echo "æ­£åœ¨å¼ºè¡Œä¸‹è½½ A311D ç¨³å®šå†…æ ¸..."
          # è¿™é‡Œä½¿ç”¨ ophub ä»“åº“é‡ŒçœŸå®å­˜åœ¨çš„ 5.15.167 é“¾æ¥
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/5.15.167.tar.gz \
            https://github.com/ophub/kernel/releases/download/kernel_stable/5.15.167.tar.gz
          echo "âœ… å†…æ ¸é¢„è½½å®Œæˆ"

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          openwrt_kernel: 5.15.167
          auto_kernel: false  # å¿…é¡»è®¾ä¸º falseï¼Œé˜²æ­¢å®ƒå»ä¹±æœåˆ«çš„ç‰ˆæœ¬
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æ•´ç†å›ºä»¶
        run: |
          mkdir -p final_out
          # ç›´æ¥å» output ç›®å½•ä¸‹æ‰¾ï¼Œé‚£æ˜¯æ’ä»¶çš„é»˜è®¤è¾“å‡º
          if [ -d "output" ]; then
            cp output/*.img.gz final_out/ 2>/dev/null || true
          fi
          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå…¨ç³»ç»Ÿæœ
          if [ -z "$(ls -A final_out)" ]; then
            find . -name "*.img.gz" ! -name "*rootfs*" -exec cp {} final_out/ \;
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-Fixed-${{ github.run_id }}
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
