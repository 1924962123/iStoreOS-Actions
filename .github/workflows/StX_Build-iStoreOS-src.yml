name: ğŸ’¿ StX_Build-A311D-OES-ULTIMATE
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ› ï¸ æš´åŠ›æ³¨å…¥å†…æ ¸ (è·³è¿‡æ‰€æœ‰è”ç½‘æ£€æŸ¥)
        run: |
          # 1. åˆ›å»ºå­˜æ”¾ç›®å½•
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          
          # 2. å¼ºè¡Œä¸‹è½½ 5.15.193 (ç›®å‰æœ€ç¨³ä¸”å­˜åœ¨çš„ç‰ˆæœ¬)
          echo "ğŸŒ å¼ºè¡Œä¸‹è½½å†…æ ¸åŒ…..."
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/5.15.193.tar.gz \
            https://github.com/ophub/kernel/releases/download/kernel_stable/5.15.193.tar.gz
          
          # 3. è¿™é‡Œçš„å…³é”®ï¼šæ’ä»¶ä¼šæ£€æŸ¥ sha256ï¼Œæˆ‘ä»¬ç›´æ¥ç»™å®ƒä¼ªé€ å¥½æ ¡éªŒæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
          # åŒæ—¶åšä¸€å †è½¯é“¾æ¥ï¼Œç®¡å®ƒæ‰¾å“ªä¸ªç‰ˆæœ¬ï¼Œé€šé€šæŒ‡å‘è¿™ä¸ªä¸‹å¥½çš„æ–‡ä»¶
          cd amlogic-s9xxx-openwrt/amlogic-kernel
          ln -sf 5.15.193.tar.gz 5.15.1.tar.gz
          ln -sf 5.15.193.tar.gz 6.6.1.tar.gz
          cd ../..

      - name: ğŸ§± å¼ºåˆ¶æœ¬åœ°æ‰“åŒ…
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          # è¿™é‡Œå¡«ä¸€ä¸ªæ’ä»¶ç»å¯¹ä¼šè®¤çš„â€œå®‰å…¨ç‰ˆæœ¬â€
          openwrt_kernel: 5.15.193
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æœå¯»å›ºä»¶
        if: always()
        run: |
          mkdir -p final_out
          # æš´åŠ›æœç´¢ï¼šåªè¦æ˜¯ img.gz ä¸”ä¸æ˜¯ rootfs ç»Ÿç»Ÿæ‹¿èµ°
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/ \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ è¿˜æ˜¯æ²¡åŒ…ï¼Ÿçœ‹è¿™é‡Œï¼šå¦‚æœè¿™ä¸€æ­¥æ²¡åŒ…ï¼Œè¯´æ˜æ‰“åŒ…è„šæœ¬å†…éƒ¨é€»è¾‘å½»åº•å´©äº†ã€‚"
            # æ‰“å°å½“å‰æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼Œæ–¹ä¾¿æˆ‘çœ‹çœ‹åˆ°åº•ç”Ÿæˆåœ¨å“ªäº†
            find . -maxdepth 4 -name "*img*"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-STABLE
          name: A311D-OES ç½‘å¿ƒäº‘ä¸“ä¾› (iStoreOS)
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
