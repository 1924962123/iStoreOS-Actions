name: ğŸ’¿ StX_Build-A311D-OES-FORCE
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ› ï¸ å¼ºåˆ¶æ³¨å…¥å†…æ ¸å¹¶è¦†ç›–æ’ä»¶é…ç½®
        run: |
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          echo "ğŸŒ æ­£åœ¨ä¸‹è½½å·²éªŒè¯å­˜åœ¨çš„ 5.15.193 å†…æ ¸..."
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/5.15.193.tar.gz \
            https://github.com/ophub/kernel/releases/download/kernel_stable/5.15.193.tar.gz
          
          # å…³é”®ä¸€æ­¥ï¼šå¦‚æœæ’ä»¶è¿˜æŠ¥å‹å·ä¸æ”¯æŒï¼Œæˆ‘ä»¬å°±å¼ºè¡Œä¿®æ”¹å®ƒçš„é…ç½®æ–‡ä»¶ï¼ˆå‡è®¾å®ƒåœ¨å½“å‰ç›®å½•ï¼‰
          # ä½†æœ€ç®€å•çš„åŠæ³•æ˜¯åé¢æ‰“åŒ…æ—¶æ”¹ç”¨é€šç”¨å‹å·å

      - name: ğŸ§± å¼ºåˆ¶æ‰“åŒ… (ä¼ªè£…å‹å·ç»•è¿‡ç™½åå•)
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          # æ ¸å¿ƒæŠ€å·§ï¼šä½¿ç”¨æ’ä»¶ä¸€å®šæ”¯æŒçš„å‹å·åï¼Œä½† A311D-OES æœ¬è´¨ä¸Šæ˜¯é€šç”¨ armsr ç»“æ„
          openwrt_board: s922x
          openwrt_kernel: 5.15.193
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æœå¯»å¹¶é‡å‘½åå›ºä»¶
        if: always()
        run: |
          mkdir -p final_out
          # åªè¦æ˜¯ç”Ÿæˆçš„ img.gz ç»Ÿç»Ÿæ”¹åä¸º A311D-OES ä¸“å±å
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/istoreos_A311D_OES_stable.img.gz \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ ä¾ç„¶å¤±è´¥ã€‚è¿™è¯´æ˜è¯¥æ’ä»¶çš„åˆ†æ”¯ç‰ˆæœ¬è¿‡æ—§ï¼Œå®Œå…¨æ— æ³•å¤„ç†æ–°å†…æ ¸ã€‚"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-SUCCESS
          name: A311D-OES é€‚é…å›ºä»¶ (å¼ºåˆ¶ç”Ÿæˆç‰ˆ)
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
