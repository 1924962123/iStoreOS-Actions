name: ğŸ’¿ StX_Build-A311D-OES-Fixed
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5
  # è¿™é‡Œå®šä¹‰ç›®å‰ kernel_stable ä¸­çœŸå®å­˜åœ¨ä¸”æœ€ç¨³çš„ç‰ˆæœ¬
  K_VER: "5.15.167" 

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸš€ å¼ºè¡Œæ³¨å…¥å†…æ ¸ (è§£å†³ 404)
        run: |
          # åˆ›å»ºæ’ä»¶é»˜è®¤æœç´¢å†…æ ¸çš„æœ¬åœ°ç›®å½•
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          echo "æ­£åœ¨ä» ophub å¼ºè¡Œä¸‹è½½ A311D ç¨³å®šç‰ˆå†…æ ¸..."
          # ç›´æ¥ä½¿ç”¨æµè§ˆå™¨èƒ½è®¿é—®çš„çœŸå®ä¸‹è½½åœ°å€ 
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/${{ env.K_VER }}.tar.gz \
            https://github.com/ophub/kernel/releases/download/kernel_stable/${{ env.K_VER }}.tar.gz
          
          if [ ! -f "amlogic-s9xxx-openwrt/amlogic-kernel/${{ env.K_VER }}.tar.gz" ]; then
            echo "âŒ å†…æ ¸ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥ï¼"
            exit 1
          fi
          echo "âœ… å†…æ ¸å·²å‡†å¤‡å°±ç»ª"

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          openwrt_kernel: ${{ env.K_VER }}
          auto_kernel: false  # å…³é”®ï¼šè®¾ä¸º falseï¼Œå¼ºåˆ¶å®ƒç”¨æˆ‘ä»¬åˆšæ‰ä¸‹è½½å¥½çš„æœ¬åœ°å†…æ ¸
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æ•´ç†å¹¶æœå¯»å›ºä»¶
        run: |
          mkdir -p final_out
          # 1. å°è¯•ä»é»˜è®¤è¾“å‡ºç›®å½•æ‰¾
          [ -d "output" ] && cp output/*.img.gz final_out/ 2>/dev/null || true
          
          # 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå…¨ç³»ç»Ÿæœç´¢ç”Ÿæˆçš„ img.gz
          if [ -z "$(ls -A final_out)" ]; then
            find . -name "*.img.gz" ! -name "*rootfs*" -exec cp {} final_out/ \;
          fi
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ è¿˜æ˜¯æ²¡æ‰¾åˆ°å›ºä»¶åŒ…ï¼Œæ‰“åŒ…é€»è¾‘å¯èƒ½ç”±äºå†…æ ¸ä¸åŒ¹é…ä¸­æ–­äº†"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-iStoreOS-${{ github.run_id }}
          name: A311D-OES ä¸“å± iStoreOS (å†…æ ¸ ${{ env.K_VER }})
          body: |
            ğŸ‘¤ è´¦å·: root | å¯†ç : æ— 
            ğŸ§  å†…æ ¸ç‰ˆæœ¬: ${{ env.K_VER }} (å·²è§£å†³ 404 æ³¨å…¥é—®é¢˜)
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
