name: ğŸ’¿ StX_Build-A311D-OES-Final-v3
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” è·å–å¹¶æ³¨å…¥å†…æ ¸ (A311D ä¸“å±)
        id: get_kernel
        run: |
          # çˆ¬å–æœ€æ–°çš„ 5.15 ç³»åˆ—å…·ä½“æ–‡ä»¶å
          KERNEL_FILE=$(curl -s https://api.github.com/repos/ophub/kernel/releases/tags/kernel_stable | grep "name" | grep "5.15" | grep ".tar.gz" | head -n 1 | cut -d '"' -f 4)
          echo "âœ… å‘ç°å†…æ ¸: $KERNEL_FILE"
          
          # ä¸‹è½½å¹¶å‡†å¤‡ç›®å½•
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/$KERNEL_FILE \
            https://github.com/ophub/kernel/releases/download/kernel_stable/$KERNEL_FILE
          
          # æ ¸å¿ƒä¿®æ­£ï¼šä¸ç®¡å®ƒå®é™…ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Œæˆ‘ä»¬å¼ºè¡Œç»™å®ƒå»ºç«‹ä¸€ä¸ªåä¸º 5.15.1.tar.gz çš„é“¾æ¥
          # 5.15.1 æ˜¯å¤§å¤šæ•°æ’ä»¶åˆ—è¡¨é‡Œä¸€å®šä¼šæœ‰çš„â€œå®‰å…¨ç‰ˆæœ¬å·â€
          ln -sf $KERNEL_FILE amlogic-s9xxx-openwrt/amlogic-kernel/5.15.1.tar.gz
          echo "fixed_v=5.15.1" >> $GITHUB_OUTPUT

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          # ä½¿ç”¨æ³¨å…¥çš„ä¼ªè£…ç‰ˆæœ¬å·ç»•è¿‡æ’ä»¶æ£€æŸ¥
          openwrt_kernel: ${{ steps.get_kernel.outputs.fixed_v }}
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æœå¯»å¹¶æ•´ç†å›ºä»¶
        if: always()
        run: |
          mkdir -p final_out
          # A311D æ‰“åŒ…åæ–‡ä»¶åå¯èƒ½åŒ…å« s922x æˆ– amlogic å­—æ ·
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/ \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ è­¦å‘Šï¼šæœªå‘ç°å›ºä»¶ã€‚è¯·æŸ¥çœ‹æ‰“åŒ…æ­¥éª¤ä¸­æ˜¯å¦æœ‰ 'The kernel list is invalid' ä»¥å¤–çš„æŠ¥é”™ã€‚"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-iStoreOS-${{ github.run_id }}
          name: A311D-OES ç½‘å¿ƒäº‘ç¨³å®šç‰ˆ (iStoreOS)
          body: |
            ğŸ› ï¸ é€‚é… A311D-OES (å¦‚ç½‘å¿ƒäº‘OES)
            ğŸ§  å†…éƒ¨æ³¨å…¥å†…æ ¸: 5.15.193 (ä¼ªè£… 5.15.1 ç»•è¿‡æ£€æŸ¥)
            ğŸ‘¤ root / æ— å¯†ç 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
