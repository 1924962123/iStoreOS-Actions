name: ğŸ’¿ StX_Build-A311D-OES-AutoFix
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” åŠ¨æ€è·å–å†…æ ¸ä¸‹è½½é“¾æ¥ (è§£å†³404)
        id: get_kernel
        run: |
          echo "ğŸŒ æ­£åœ¨ä» ophub ä»“åº“æ£€ç´¢ 5.15 ç¨³å®šç‰ˆå†…æ ¸..."
          # çˆ¬å– Release é¡µé¢å¹¶ç­›é€‰ 5.15 çš„ .tar.gz æ–‡ä»¶å
          KERNEL_FILE=$(curl -s https://api.github.com/repos/ophub/kernel/releases/tags/kernel_stable | grep "name" | grep "5.15" | grep ".tar.gz" | head -n 1 | cut -d '"' -f 4)
          
          if [ -z "$KERNEL_FILE" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° 5.15 å†…æ ¸æ–‡ä»¶ï¼Œå°è¯•æ£€ç´¢ 6.1..."
            KERNEL_FILE=$(curl -s https://api.github.com/repos/ophub/kernel/releases/tags/kernel_stable | grep "name" | grep "6.1" | grep ".tar.gz" | head -n 1 | cut -d '"' -f 4)
          fi
          
          # æå–çº¯ç‰ˆæœ¬å·ç”¨äºæ’ä»¶è¯†åˆ« (ä¾‹å¦‚ 5.15.167)
          K_VER=$(echo $KERNEL_FILE | cut -d '.' -f 1,2,3 | cut -d '-' -f 1)
          
          echo "âœ… æ‰¾åˆ°æœ€æ–°å†…æ ¸æ–‡ä»¶: $KERNEL_FILE"
          echo "k_file=$KERNEL_FILE" >> $GITHUB_OUTPUT
          echo "k_ver=$K_VER" >> $GITHUB_OUTPUT
          
          # æå‰ä¸‹è½½åˆ°æ’ä»¶ç›®å½•
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/$KERNEL_FILE \
            https://github.com/ophub/kernel/releases/download/kernel_stable/$KERNEL_FILE
          
          # å»ºç«‹è½¯é“¾æ¥ï¼Œé˜²æ­¢æ’ä»¶æ‰¾ä¸åˆ°å¯¹åº”çš„æ–‡ä»¶å
          ln -s $KERNEL_FILE amlogic-s9xxx-openwrt/amlogic-kernel/$K_VER.tar.gz

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          openwrt_kernel: ${{ steps.get_kernel.outputs.k_ver }}
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æ•´ç†å¹¶æœå¯»å›ºä»¶
        run: |
          mkdir -p final_out
          # å…¨å±€æœç´¢ç”Ÿæˆçš„ img.gz
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/ \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ æ‰“åŒ…å¤±è´¥ï¼Œæœªç”Ÿæˆå›ºä»¶åŒ…ã€‚"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-iStoreOS-${{ github.run_id }}
          name: A311D-OES è‡ªåŠ¨åŒ¹é…ç‰ˆ (å†…æ ¸ ${{ steps.get_kernel.outputs.k_ver }})
          body: |
            ğŸ› ï¸ ä¸“ä¸º A311D-OES é€‚é…
            ğŸ§  è‡ªåŠ¨åŒ¹é…å†…æ ¸: ${{ steps.get_kernel.outputs.k_file }}
            ğŸ‘¤ ç”¨æˆ·: root | å¯†ç : æ— 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
