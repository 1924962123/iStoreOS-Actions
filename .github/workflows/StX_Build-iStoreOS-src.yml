name: ğŸ’¿ StX_Build-A311D-OES-Final-Verified
on:
  workflow_dispatch:

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸš€ å¼ºåˆ¶æ³¨å…¥æœ¬åœ°å†…æ ¸
        id: kernel
        run: |
          # 1. è·å–å½“å‰ kernel_stable çœŸæ­£å­˜åœ¨çš„æ–‡ä»¶å
          KERNEL_FILE=$(curl -s https://api.github.com/repos/ophub/kernel/releases/tags/kernel_stable | grep "name" | grep "5.15" | grep ".tar.gz" | head -n 1 | cut -d '"' -f 4)
          # æå–ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ 5.15.193ï¼‰
          K_VER=$(echo $KERNEL_FILE | cut -d '.' -f 1,2,3 | cut -d '-' -f 1)
          
          echo "ğŸŒ æ­£åœ¨æ³¨å…¥å†…æ ¸: $KERNEL_FILE (è¯†åˆ«ä¸º $K_VER)"
          
          # 2. åˆ›å»ºæ’ä»¶å­˜æ”¾å†…æ ¸çš„ç»å¯¹è·¯å¾„
          mkdir -p amlogic-s9xxx-openwrt/amlogic-kernel
          
          # 3. ä¸‹è½½å¹¶å­˜æ”¾
          curl -L -o amlogic-s9xxx-openwrt/amlogic-kernel/$KERNEL_FILE \
            https://github.com/ophub/kernel/releases/download/kernel_stable/$KERNEL_FILE
          
          # 4. å…³é”®ï¼šåŒæ—¶åˆ›å»ºå¤šä¸ªè½¯é“¾æ¥ï¼Œå µæ­»æ’ä»¶å¯»æ‰¾æ‰€æœ‰å¯èƒ½ç‰ˆæœ¬çš„è·¯å¾„
          cd amlogic-s9xxx-openwrt/amlogic-kernel
          ln -sf $KERNEL_FILE $K_VER.tar.gz
          ln -sf $KERNEL_FILE 5.15.y.tar.gz
          cd ../..
          
          echo "k_ver=$K_VER" >> $GITHUB_OUTPUT

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶ (ä½¿ç”¨æ³¨å…¥ç‰ˆæœ¬)
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz
          openwrt_board: a311d-oes
          # ä½¿ç”¨è·å–åˆ°çš„çœŸå®ç‰ˆæœ¬å·ï¼Œç¡®ä¿æ’ä»¶å†…éƒ¨åˆ—è¡¨åŒ¹é…
          openwrt_kernel: ${{ steps.kernel.outputs.k_ver }}
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable

      - name: ğŸ“œ æœå¯»å¹¶æ•´ç†å›ºä»¶
        if: always()
        run: |
          mkdir -p final_out
          # A311D æœ‰æ—¶ä¼šç”Ÿæˆåœ¨ outputï¼Œæœ‰æ—¶åœ¨å­ç›®å½•ï¼Œç›´æ¥å…¨å±€æœ img.gz
          find . -name "*.img.gz" ! -name "*rootfs*" -size +50M -exec cp {} final_out/ \;
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ è¿˜æ˜¯æ²¡ç”Ÿæˆå›ºä»¶ã€‚è¯·æ£€æŸ¥ 'ğŸ§± æ‰“åŒ…å›ºä»¶' æ­¥éª¤æ˜¯å¦æœ‰å…¶ä»–çº¢å­—æŠ¥é”™ã€‚"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-Fixed-${{ github.run_id }}
          name: A311D-OES ä¸“å± iStoreOS (ç¨³å®šç‰ˆå†…æ ¸)
          body: |
            ğŸ› ï¸ é€‚é…ç½‘å¿ƒäº‘ OES (A311D)
            ğŸ‘¤ root / æ— å¯†ç 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
