name: ğŸ’¿ StX_Build-A311D-OES-iStoreOS
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "1ã€è®¾å¤‡å‹å·"
        required: true
        default: "a311d-oes"
        type: choice
        options:
          - a311d-oes
          - s905x3
          - s922x
      openwrt_kernel:
        description: "2ã€å†…æ ¸é€‰æ‹© (ç½‘å¿ƒäº‘å»ºè®®5.15)"
        required: true
        default: "5.15.160"
        type: choice
        options:
          - 5.15.160
          - 6.1.100
          - 6.6.74
      auto_kernel:
        description: "è‡ªåŠ¨åŒ¹é…æœ€æ–°å†…æ ¸"
        required: false
        default: true
        type: boolean

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ iStoreOS Rootfs
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” æŸ¥æ‰¾rootfsè·¯å¾„
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ§± æ‰“åŒ…å›ºä»¶ (Amlogic æ‰“åŒ…æ’ä»¶)
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: ${{ inputs.auto_kernel }}
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: ğŸ“œ å¼ºåˆ¶æœç´¢å¹¶æ•´ç†å›ºä»¶
        id: organize
        run: |
          mkdir -p final_out
          echo "ğŸ” æ­£åœ¨å…¨ç³»ç»Ÿæœç´¢æ‰“åŒ…å¥½çš„å›ºä»¶..."
          # æœç´¢æ‰€æœ‰å¤§äº100Mä¸”ä»¥img.gzç»“å°¾çš„æ–‡ä»¶
          find . -type f -name "*.img.gz" -size +100M | while read -r FILE; do
            FILENAME=$(basename "$FILE")
            # è¿‡æ»¤æ‰åŸå§‹rootfsï¼Œåªå¤„ç†ç”Ÿæˆçš„å›ºä»¶
            if [[ "$FILENAME" != *"rootfs"* ]]; then
              NEW_NAME="istoreos_${{ inputs.openwrt_board }}_${{ inputs.openwrt_kernel }}.img.gz"
              cp "$FILE" "final_out/$NEW_NAME"
              echo "âœ… å‘ç°å¹¶å¤åˆ¶å›ºä»¶: $NEW_NAME"
            fi
          done
          
          if [ -z "$(ls -A final_out)" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ²¡æ‰¾åˆ°å›ºä»¶åŒ…ï¼Œè¯·æ£€æŸ¥æ‰“åŒ…æ—¥å¿—ï¼"
            exit 1
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: A311D-OES-iStoreOS-${{ env.VERSION }}
          name: A311D-OES ç¨³å®šç‰ˆ iStoreOS (å†…æ ¸ ${{ inputs.openwrt_kernel }})
          body: |
            ğŸ› ï¸ ä¸“ä¸º A311D-OES ç¼–è¯‘
            ğŸ§  å†…æ ¸ç‰ˆæœ¬: ${{ inputs.openwrt_kernel }}
            ğŸ“¦ é€‚åˆè·‘ç½‘å¿ƒäº‘ Dockerï¼Œå»ºè®®åˆ·å…¥ EMMC åä½¿ç”¨ã€‚
            ğŸ‘¤ è´¦å·: root | å¯†ç : æ— 
          files: final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
