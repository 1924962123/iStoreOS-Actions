name: ğŸ’¿ StX_Build-iStoreOS-src
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "1ã€è¯·é€‰æ‹©è®¾å¤‡å‹å·"
        required: true
        default: "s905d_s905x3_s912_s922x-ct2000"
        type: choice
        options:
          - s905d_s905x3_s912_s922x-ct2000
          - a311d-oes_s922x-oes-plus_wxy-oect
          - nsy-g16-plus_nsy-g68-plus_bdy-g18-pro
          - beikeyun
          - bdy-g18-pro
          - h66k
          - h68k
          - h69k
          - h88k
          - nanopi-r5s
          - nanopi-r5c
          - orangepi-5-plus
          - s905x3
          - s912
          - s922x
      openwrt_kernel:
        description: "2ã€è¯·é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ (å·²è‡ªåŠ¨é€‚é…ç¨³å®šç‰ˆé“¾æ¥)"
        required: true
        default: "6.6.y"
        type: choice
        options:
          - 6.6.y
          - 6.12.y
          - 6.1.y
          - 5.15.y
      auto_kernel:
        description: "è‡ªåŠ¨ä½¿ç”¨æœ€æ–°å†…æ ¸"
        required: false
        default: true
        type: boolean

env:
  VERSION: 24.10.5

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: â¬ ä¸‹è½½ rootfs.tar.gz
        run: |
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” æŸ¥æ‰¾rootfs.tar.gzæ‰€åœ¨è·¯å¾„
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ› ï¸ ä¿®æ­£å†…æ ¸ç‰ˆæœ¬å· (é˜²æ­¢404)
        id: kernel_fix
        run: |
          # è·å–ç”¨æˆ·è¾“å…¥
          K_VER="${{ inputs.openwrt_kernel }}"
          # å°†æ¨¡ç³Šçš„ .y è½¬æ¢ä¸ºå…·ä½“çš„ç¨³å®šç‰ˆç‰ˆæœ¬å·ï¼Œç¡®ä¿ ophub é“¾æ¥æœ‰æ•ˆ
          case "$K_VER" in
            "6.6.y")  FIXED_VER="6.6.74" ;;
            "6.12.y") FIXED_VER="6.12.1" ;;
            "6.1.y")  FIXED_VER="6.1.120" ;;
            "5.15.y") FIXED_VER="5.15.174" ;;
            *) FIXED_VER="$K_VER" ;;
          esac
          echo "fixed_v=$FIXED_VER" >> $GITHUB_OUTPUT
          echo "âœ… å†…æ ¸ç‰ˆæœ¬å·²ä» $K_VER ä¿®æ­£ä¸º $FIXED_VER"

      - name: ğŸ§± æ‰“åŒ…iStoreOSå›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          # ä½¿ç”¨ä¿®æ­£åçš„å…·ä½“ç‰ˆæœ¬å·
          openwrt_kernel: ${{ steps.kernel_fix.outputs.fixed_v }}
          auto_kernel: ${{ inputs.auto_kernel }}
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: ğŸ“œ æ•´ç†å›ºä»¶æ–‡ä»¶
        run: |
          mkdir -p final_out
          for FILE in output/*.img.gz; do
            [ -e "$FILE" ] || continue
            FILENAME=$(basename "$FILE")
            NEW_FILENAME=$(echo "$FILENAME" | sed "s/openwrt/istoreos_${{ env.VERSION }}/g")
            mv "$FILE" "final_out/$NEW_FILENAME"
          done

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: iStoreOS-${{ env.VERSION }}-SNAPSHOT-dhcp
          body: |
            ğŸ§  å†…æ ¸ç‰ˆæœ¬ï¼š${{ steps.kernel_fix.outputs.fixed_v }} (æ¥è‡ª ophub/kernel stable)
            ğŸ‘¤ ç”¨æˆ·åï¼šroot | å¯†ç ï¼šæ— 
          files: |
            final_out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
